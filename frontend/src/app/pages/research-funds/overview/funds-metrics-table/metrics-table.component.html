@if (showExpandedView()) {
  <div class="expanded-backdrop" (click)="toggleExpandedView()"></div>
}

<div class="metrics-container" [class.expanded-mode]="showExpandedView()">
  <!-- Header com tÃ­tulo do relationship -->
  <div class="table-title">
    <h3>{{ relationshipName() }}</h3>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="settings-menu">
      <button
        class="btn toolbar-btn"
        type="button"
        (click)="toggleSettingsMenu()"
      >
        <i class="pi pi-cog"></i>
        <span>Settings</span>
      </button>

      @if (showSettings()) {
        <div class="settings-panel">
          <div class="settings-group">
            <label>Grouping Period</label>
            <select
              [ngModel]="groupingPeriod()"
              (ngModelChange)="groupingPeriod.set($event)"
            >
              @for (option of groupingPeriodOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>

          <div class="settings-group">
            <label>Thousand Separator</label>
            <select
              [ngModel]="thousandSeparator()"
              (ngModelChange)="thousandSeparator.set($event)"
            >
              @for (option of separatorOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>

          <div class="settings-group">
            <label>Decimal Separator</label>
            <select
              [ngModel]="decimalSeparator()"
              (ngModelChange)="decimalSeparator.set($event)"
            >
              @for (option of separatorOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>

          <div class="settings-group">
            <label>Date Format</label>
            <select
              [ngModel]="dateFormat()"
              (ngModelChange)="dateFormat.set($event)"
            >
              @for (option of dateFormatOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>
        </div>
      }
    </div>
    <button
      class="btn toolbar-btn"
      type="button"
      [class.active]="isAccumulated()"
      (click)="toggleAccumulate()"
    >
      <i class="pi pi-arrow-up"></i>
      <span>Accumulate Rows</span>
    </button>
    <button
      class="btn toolbar-btn"
      type="button"
      (click)="toggleExpandedView()"
    >
      <i class="pi pi-expand"></i>
      <span>{{ showExpandedView() ? 'Collapse Table' : 'Expand Table' }}</span>
    </button>
    <button
      class="btn toolbar-btn"
      type="button"
      (click)="copySelectedRows()"
      [disabled]="selectedRows().size === 0"
    >
      <i class="pi pi-copy"></i>
      <span>Copy Selected Rows</span>
    </button>
    <button
      class="btn toolbar-btn"
      type="button"
      (click)="copyTable()"
    >
      <i class="pi pi-table"></i>
      <span>Copy Table</span>
    </button>
  </div>

  <!-- Table Wrapper -->
  <div class="table-shell" [class.expanded]="showExpandedView()">
    <div 
      class="table-wrapper"
      [class.expanded]="showExpandedView()"
    >
    <table class="metrics-table">
      <thead>
        <tr>
          <th class="checkbox-col">
            <span class="checkbox-placeholder"></span>
          </th>
          <th class="series-name-col">
            <span>Series Name</span>
          </th>
          @for (date of tableData().dateColumns; track date) {
            <th class="date-col">
              <span>{{ date }}</span>
            </th>
          }
        </tr>
      </thead>
      <tbody>
        @for (row of tableData().rows; track row.seriesName) {
          <tr [class.selected]="isRowSelected(row.seriesName)">
            <td class="checkbox-col">
              <input
                type="checkbox"
                class="row-checkbox"
                [checked]="isRowSelected(row.seriesName)"
                (change)="toggleRowSelection(row.seriesName)"
              />
            </td>
            <td class="series-name-cell">
              {{ row.seriesName }}
            </td>
            @for (date of tableData().dateColumns; track date) {
              <td class="value-cell">
                {{ formatValue(row.values[date], row.type) }}
              </td>
            }
          </tr>
        } @empty {
          <tr>
            <td [colSpan]="tableData().dateColumns.length + 2" class="empty-cell">
              No metrics data available
            </td>
          </tr>
        }
      </tbody>
    </table>
    </div>
  </div>
</div>
