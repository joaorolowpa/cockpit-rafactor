<div appPageContainer>
  <div appPageHeader>
    <div>
      <h1 class="page-title">Funds Backoffice</h1>
      <p class="page-subtitle">
        Create and manage funds, relationships, transactions and classifications.
      </p>
    </div>
    <div appPageActions>
      <button class="btn btn-primary" type="button" (click)="onPrimaryAction()">
        {{ topBarConfig().buttonLabel }}
      </button>
    </div>
  </div>

  <div class="tabs">
    @for (tab of tabs; track tab.key) {
      <button
        class="tab-btn"
        [class.active]="activeTab() === tab.key"
        [attr.data-tab]="tab.key"
        type="button"
        (click)="setTab(tab.key)"
      >
        <i [class]="tab.icon"></i>
        <span>{{ tab.label }}</span>
      </button>
    }
  </div>

  <div appFiltersBar>
    <app-search-input
      [placeholder]="getSearchPlaceholder()"
      [value]="searchTerm()"
      (valueChange)="searchTerm.set($event)"
      (cleared)="searchTerm.set('')"
    ></app-search-input>
    <div class="toolbar-actions">
      <button class="btn btn-ghost" type="button" (click)="copyTable('us')">
        <i class="pi pi-plus-circle"></i>
        Copy US
      </button>
      <button class="btn btn-ghost" type="button" (click)="copyTable('br')">
        <i class="pi pi-plus-circle"></i>
        Copy BR
      </button>
      <div class="view-menu">
        <button class="btn btn-ghost" type="button" (click)="toggleColumnMenu()">
          <i class="pi pi-sliders-h"></i>
          View
        </button>
        @if (showColumnMenu()) {
          <div class="view-menu-panel">
            <div class="view-menu-section">    
            </div>
            <div class="view-menu-section">
              <label class="view-menu-title">Columns</label>
              @for (column of getActiveTabAllColumns(); track column.key) {
                <app-checkbox
                  class="view-menu-item"
                  [checked]="isColumnVisible(activeTab(), column.key)"
                  (checkedChange)="toggleColumnVisibility(activeTab(), column.key)"
                  [label]="column.label"
                ></app-checkbox>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  @if (isLoading()) {
    <app-state
      type="loading"
      icon="pi pi-spinner pi-spin"
      message="Loading backoffice data..."
    ></app-state>
  } @else if (errorMessage()) {
    <app-state
      type="error"
      icon="pi pi-exclamation-circle"
      [message]="errorMessage() || ''"
    ></app-state>
  } @else {
    <div appTableContainer>
      <div appTableWrapper [compact]="compactView()">
      @if (activeTab() === 'fund_managers') {
        @if (filteredFundManagers().length === 0) {
          <div class="empty-state">
            <i class="pi pi-info-circle"></i>
            <p>No fund managers found.</p>
          </div>
        } @else {
          <table appDataTable class="data-table">
            <thead>
              <tr>
                @if (isColumnVisible('fund_managers', 'id')) { <th>ID</th> }
                @if (isColumnVisible('fund_managers', 'display_name')) { <th>Display Name</th> }
                @if (isColumnVisible('fund_managers', 'created_by_name')) { <th>Created By</th> }
                @if (isColumnVisible('fund_managers', 'created_at')) { <th>Created At</th> }
                @if (isColumnVisible('fund_managers', 'actions')) { <th>Actions</th> }
              </tr>
            </thead>
            <tbody>
              @for (fund of filteredFundManagers(); track fund.id; let i = $index) {
                <tr>
                  @if (isColumnVisible('fund_managers', 'id')) { <td>{{ fund.id }}</td> }
                  @if (isColumnVisible('fund_managers', 'display_name')) { <td>{{ fund.display_name }}</td> }
                  @if (isColumnVisible('fund_managers', 'created_by_name')) { <td>{{ fund.created_by_name || '-' }}</td> }
                  @if (isColumnVisible('fund_managers', 'created_at')) { <td>{{ fund.created_at || '-' }}</td> }
                  @if (isColumnVisible('fund_managers', 'actions')) {
                    <td>
                      <button
                        class="btn btn-text icon-btn delete-btn"
                        type="button"
                        disabled
                        aria-label="Delete fund manager"
                        title="Delete (disabled)"
                      >
                        <i class="pi pi-trash"></i>
                      </button>
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        }
      } @else if (activeTab() === 'fund_relationships') {
        @if (filteredRelationships().length === 0) {
          <div class="empty-state">
            <i class="pi pi-info-circle"></i>
            <p>No fund relationships found.</p>
          </div>
        } @else {
          <table appDataTable class="data-table">
            <thead>
              <tr>
                @if (isColumnVisible('fund_relationships', 'id')) { <th>ID</th> }
                @if (isColumnVisible('fund_relationships', 'fund_manager_display_name')) { <th>Fund Manager</th> }
                @if (isColumnVisible('fund_relationships', 'asset_display_name')) { <th>Asset</th> }
                @if (isColumnVisible('fund_relationships', 'commitment')) { <th>Commitment</th> }
                @if (isColumnVisible('fund_relationships', 'nav')) { <th>NAV</th> }
                @if (isColumnVisible('fund_relationships', 'irr')) { <th>IRR</th> }
              </tr>
            </thead>
            <tbody>
              @for (rel of filteredRelationships(); track rel.id) {
                <tr>
                  @if (isColumnVisible('fund_relationships', 'id')) { <td>{{ rel.id }}</td> }
                  @if (isColumnVisible('fund_relationships', 'fund_manager_display_name')) { <td>{{ rel.fund_manager_display_name }}</td> }
                  @if (isColumnVisible('fund_relationships', 'asset_display_name')) { <td>{{ rel.asset_display_name }}</td> }
                  @if (isColumnVisible('fund_relationships', 'commitment')) { <td>{{ rel.commitment }}</td> }
                  @if (isColumnVisible('fund_relationships', 'nav')) { <td>{{ rel.nav }}</td> }
                  @if (isColumnVisible('fund_relationships', 'irr')) { <td>{{ rel.irr }}</td> }
                </tr>
              }
            </tbody>
          </table>
        }
      } @else if (activeTab() === 'funds_classifications') {
        @if (filteredClassifications().length === 0) {
          <div class="empty-state">
            <i class="pi pi-info-circle"></i>
            <p>No classifications found.</p>
          </div>
        } @else {
          <table appDataTable class="data-table">
            <thead>
              <tr>
                @if (isColumnVisible('funds_classifications', 'display_name')) { <th>Display Name</th> }
                @if (isColumnVisible('funds_classifications', 'lote45_asset_type')) { <th>Asset Type</th> }
                @if (isColumnVisible('funds_classifications', 'milestones_fund_type')) { <th>Fund Type</th> }
                @if (isColumnVisible('funds_classifications', 'milestones_benchmark')) { <th>Benchmark</th> }
              </tr>
            </thead>
            <tbody>
              @for (item of filteredClassifications(); track item.id) {
                <tr>
                  @if (isColumnVisible('funds_classifications', 'display_name')) { <td>{{ item.display_name || '-' }}</td> }
                  @if (isColumnVisible('funds_classifications', 'lote45_asset_type')) { <td>{{ item.lote45_asset_type || '-' }}</td> }
                  @if (isColumnVisible('funds_classifications', 'milestones_fund_type')) { <td>{{ item.milestones_fund_type || '-' }}</td> }
                  @if (isColumnVisible('funds_classifications', 'milestones_benchmark')) { <td>{{ item.milestones_benchmark || '-' }}</td> }
                </tr>
              }
            </tbody>
          </table>
        }
      } @else if (activeTab() === 'transactions_ledger') {
        @if (filteredTransactions().length === 0) {
          <div class="empty-state">
            <i class="pi pi-info-circle"></i>
            <p>No transactions found.</p>
          </div>
        } @else {
          <table appDataTable class="data-table">
            <thead>
              <tr>
                @if (isColumnVisible('transactions_ledger', 'id')) { <th>ID</th> }
                @if (isColumnVisible('transactions_ledger', 'fund_manager_display_name')) { <th>Fund Manager</th> }
                @if (isColumnVisible('transactions_ledger', 'asset_display_name')) { <th>Asset</th> }
                @if (isColumnVisible('transactions_ledger', 'transaction_type')) { <th>Type</th> }
                @if (isColumnVisible('transactions_ledger', 'amount')) { <th>Amount</th> }
                @if (isColumnVisible('transactions_ledger', 'transaction_date')) { <th>Date</th> }
              </tr>
            </thead>
            <tbody>
              @for (item of filteredTransactions(); track item.id) {
                <tr>
                  @if (isColumnVisible('transactions_ledger', 'id')) { <td>{{ item.id }}</td> }
                  @if (isColumnVisible('transactions_ledger', 'fund_manager_display_name')) { <td>{{ item.fund_manager_display_name || '-' }}</td> }
                  @if (isColumnVisible('transactions_ledger', 'asset_display_name')) { <td>{{ item.asset_display_name || '-' }}</td> }
                  @if (isColumnVisible('transactions_ledger', 'transaction_type')) { <td>{{ item.transaction_type || '-' }}</td> }
                  @if (isColumnVisible('transactions_ledger', 'amount')) { <td>{{ item.amount ?? '-' }}</td> }
                  @if (isColumnVisible('transactions_ledger', 'transaction_date')) { <td>{{ item.transaction_date || '-' }}</td> }
                </tr>
              }
            </tbody>
          </table>
        }
      }
      </div>
    </div>
  }
</div>
