<div appPageContainer>
  <div appPageHeader>
    <h1 class="page-title">{{ fund()?.display_name || 'Fund Manager' }}</h1>
  </div>

  @if (isLoading()) {
    <div class="loading-state">
      <i class="pi pi-spinner pi-spin"></i>
      <p>Loading fund manager...</p>
    </div>
  }

  @if (error() && !isLoading()) {
    <div class="error-state">
      <i class="pi pi-exclamation-circle"></i>
      <p>{{ error() }}</p>
      <a
        class="btn btn-secondary"
        [routerLink]="['/research-funds/fund-managers']"
      >
        Back to list
      </a>
    </div>
  }

  @if (!isLoading() && !error()) {
    <div class="content">
      <div class="tabs">
        <button class="tab-btn" [class.active]="activeTab() === 'home'" (click)="setTab('home')">Overview</button>
        <button class="tab-btn" [class.active]="activeTab() === 'relationships'" (click)="setTab('relationships')">Relationships</button>
        <button class="tab-btn" [class.active]="activeTab() === 'documents'" (click)="setTab('documents')">Documents</button>
      </div>

      @if (activeTab() === 'home') {
        <div class="tab-content">
          <div class="card">
            <div class="card-header">
              <h3>About</h3>
              <button class="btn btn-secondary" type="button" (click)="openEditDialog()">Edit</button>
            </div>
            <div class="section">
              <div class="section-title">Firm</div>
              <div class="rich-content" [innerHTML]="sanitizeHtml(fundDetails()?.content?.firm_about)"></div>
            </div>
            <div class="section">
              <div class="section-title">Strategies</div>
              <div class="rich-content" [innerHTML]="sanitizeHtml(fundDetails()?.content?.firm_strategies)"></div>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Website</span>
                <a class="link" [href]="fundDetails()?.content?.website" target="_blank" rel="noopener">
                  {{ fundDetails()?.content?.website || '-' }}
                </a>
              </div>
              <div class="info-item">
                <span class="label">AUM</span>
                <span class="value">{{ fundDetails()?.content?.firm_aum || '-' }}</span>
              </div>
            </div>
            <div class="section">
              <div class="section-title">Contact Information</div>
              <div class="rich-content" [innerHTML]="sanitizeHtml(fundDetails()?.content?.contact_information)"></div>
            </div>
          </div>

          <div class="card">
            <h3>Notes</h3>
            @if (notesError()) {
              <div class="notice">Failed to load notes.</div>
            }
            @if (!notesError() && notes().length === 0) {
              <div class="empty-state">
                <i class="pi pi-info-circle"></i>
                <p>No notes available for this fund manager</p>
              </div>
            }
            @if (!notesError() && notes().length > 0) {
              <div class="notes-grid">
                @for (note of notes(); track note.note_id) {
                  <div class="note-card">
                    <div class="note-title">{{ note.note_title }}</div>
                    <div class="note-meta">{{ note.created_by_name || '-' }} Â· {{ note.created_at | date: 'mediumDate' }}</div>
                    <div class="note-preview">{{ note.content_preview || '' }}</div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }

      @if (activeTab() === 'relationships') {
        <div class="tab-content">
          <div class="card">
            <div class="card-header">
              <h3>Relationships</h3>
              <span class="badge">{{ relationships().length }}</span>
            </div>

            @if (relationshipsError()) {
              <div class="notice">
                Failed to load relationships.
              </div>
            }

            @if (!relationshipsError() && relationships().length === 0) {
              <div class="empty-state">
                <i class="pi pi-search"></i>
                <p>No relationships found</p>
              </div>
            }

            @if (!relationshipsError() && relationships().length > 0) {
              <div>
                <div class="relationship-controls">
                  <select
                    class="relationship-dropdown"
                    [ngModel]="selectedRelationshipId()"
                    (ngModelChange)="selectedRelationshipId.set($event)"
                  >
                    <option [ngValue]="null" disabled>Select relationship</option>
                    @for (option of relationshipOptions(); track option.value) {
                      <option [ngValue]="option.value">
                        {{ option.label }}
                      </option>
                    }
                  </select>
                  <button class="btn btn-secondary" type="button" disabled>Edit</button>
                </div>

                <div class="section">
                  <div class="section-title">About</div>
                  @if (relationshipDetailsError()) {
                    <div class="notice">
                      Failed to load relationship details.
                    </div>
                  }
                  @if (!relationshipDetailsError() && relationshipDetails()?.content) {
                    <div class="info-grid">
                      <div class="info-item">
                        <span class="label">Sector</span>
                        <span class="value">{{ relationshipDetails()?.content?.sectors || '-' }}</span>
                      </div>
                      <div class="info-item">
                        <span class="label">Investment Team</span>
                        <span class="value">{{ relationshipDetails()?.content?.investment_team || '-' }}</span>
                      </div>
                    </div>
                    <div class="section">
                      <div class="section-title">Profile of Investments</div>
                      <div class="rich-content" [innerHTML]="sanitizeHtml(relationshipDetails()?.content?.profile_of_investments)"></div>
                    </div>
                  }
                  @if (!relationshipDetailsError() && !relationshipDetails()?.content) {
                    <div class="empty-state">
                      <i class="pi pi-info-circle"></i>
                      <p>No details available for this relationship. {{!relationshipDetailsError() }}  {{!relationshipDetails()?.content}}     </p>
                    </div>
                  }
                </div>

                <div class="section">
                  <div class="section-title">Charts</div>
                  @if (!selectedMetrics()) {
                    <div class="empty-state">
                      <i class="pi pi-chart-line"></i>
                      <p>No charts available for this relationship.</p>
                    </div>
                  }
                  @if (selectedMetrics()) {
                    <div class="charts-grid">
                      @for (series of relationshipSeries; track series.key) {
                        <div class="chart-card">
                          <div class="chart-title">{{ series.label }}</div>
                          <div class="chart-body">
                            <p-chart
                              type="line"
                              [data]="getChartData(series.key)"
                              [options]="chartOptions"
                            ></p-chart>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>

                <div class="section">
                  <div class="section-title">Metrics</div>
                  @if (!selectedMetrics()) {
                    <div class="empty-state">
                      <i class="pi pi-info-circle"></i>
                      <p>No metrics available for this relationship.</p>
                    </div>
                  }
                  @if (selectedMetrics()) {
                    <div class="relationships-accordion">
                      <app-funds-accordion [groupedFunds]="selectedRelationshipGroup()" />
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }

      @if (activeTab() === 'documents') {
        <div class="tab-content">
          <div class="card">
            <div class="card-header">
              <h3>Documents</h3>
              <span class="badge">{{ documents().length }}</span>
            </div>

            @if (documentsError()) {
              <div class="notice">
                Failed to load documents.
              </div>
            }

            @if (!documentsError() && documents().length === 0) {
              <div class="empty-state">
                <i class="pi pi-folder-open"></i>
                <p>No documents available</p>
              </div>
            }

            @if (!documentsError() && documents().length > 0) {
              <div appTableWrapper>
                <table appDataTable class="data-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Document Type</th>
                      <th>Entity Display Name</th>
                      <th>Entity Type</th>
                      <th>Created By</th>
                      <th>Date Reference</th>
                      <th>Created At</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (document of documents(); track document.id) {
                      <tr>
                        <td>{{ document.id }}</td>
                        <td>{{ mapDocumentType(document.document_type) }}</td>
                        <td>{{ document.entity_display_name }}</td>
                        <td class="chip">{{ document.entity_type ? document.entity_type.toUpperCase().replace('_', ' ') : '-' }}</td>
                        <td>{{ document.created_by_name || '-' }}</td>
                        <td>{{ document.date_reference ? (document.date_reference | date: 'yyyy-MM-dd') : '-' }}</td>
                        <td>{{ document.created_at ? (document.created_at | date: 'medium') : '-' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
  @if (showEditDialog() && fundManagerId()) {
    <app-fund-manager-edit-dialog
      [fundManagerId]="fundManagerId()!"
      [content]="fundDetails()?.content ?? null"
      (close)="closeEditDialog()"
      (updated)="onDetailsUpdated($event)"
    />
  }
</div>
