<div appPageContainer>
  <div appPageHeader>
    <div>
      <h1 class="page-title">Assets</h1>
      <p class="page-subtitle">This is Milestones Asset Classification</p>
    </div>
  </div>

  <div class="tabs">
    @for (tab of tabs; track trackByTab($index, tab)) {
      <button
        class="tab-btn"
        type="button"
        [class.active]="activeTab() === tab.key"
        [class.disabled]="tab.disabled"
        (click)="setTab(tab.key)"
        [attr.data-tooltip]="tab.disabled ? 'Coming soon' : tab.label"
        [attr.aria-label]="tab.label"
      >
        <i [class]="tab.icon"></i>
        <span class="tab-label">{{ tab.label }}</span>
      </button>
    }
  </div>

  <div appTableContainer>
    @if (!loading() && !error()) {
      <div appFiltersBar>
        <app-search-input
          placeholder="Search by display name..."
          [value]="searchTerm()"
          (valueChange)="searchTerm.set($event)"
          (cleared)="searchTerm.set('')"
        ></app-search-input>

        @if (hasColumn('lote45_asset_type')) {
          <select
            class="type-filter"
            [value]="selectedLote45()"
            (change)="selectedLote45.set($any($event.target).value)"
          >
            <option value="">LOTE45 Asset Type</option>
            @for (option of lote45Options(); track option) {
              <option [value]="option">
                {{ option }}
              </option>
            }
          </select>
        }

        @if (hasColumn('milestones_asset_type')) {
          <select
            class="type-filter"
            [value]="selectedMilestones()"
            (change)="selectedMilestones.set($any($event.target).value)"
          >
            <option value="">Milestones Asset Type</option>
            @for (option of milestonesOptions(); track option) {
              <option [value]="option">
                {{ option }}
              </option>
            }
          </select>
        }

        @if (searchTerm() || selectedLote45() || selectedMilestones()) {
          <button
            appButton
            type="button"
            class="btn btn-ghost clear-filters-btn"
            (click)="clearFilters()"
          >
            Clear Filters
          </button>
        }
      </div>
    }

    @if (loading()) {
      <app-state
        type="loading"
        icon="pi pi-spinner pi-spin"
        message="Loading classifications..."
      ></app-state>
    }

    @if (error() && !loading()) {
      <app-state
        type="error"
        icon="pi pi-exclamation-circle"
        [message]="error() || ''"
        actionLabel="Retry"
        (action)="loadClassifications()"
      ></app-state>
    }

    @if (!loading() && !error() && rowsWithNoClassification().length > 0) {
      <div class="warning-card">
      <div class="warning-icon">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <div class="warning-content">
        <h3>Atenção necessária</h3>
        <p>
          Existem {{ rowsWithNoClassification().length }} itens sem classificação.
          @if (assetIdsWithNoClassification().length > 0) {
            IDs: {{ assetIdsWithNoClassification().join(', ') }}.
          }
        </p>
        <div class="warning-actions">
            <button
              type="button"
              appButton
              class="btn btn-ghost warning-btn"
              (click)="showUnclassified.set(true)"
            >
            Mostrar apenas não classificados
          </button>
            <button
              type="button"
              appButton
              class="btn btn-ghost warning-btn"
              (click)="showUnclassified.set(false)"
            >
            Mostrar todos os ativos
          </button>
        </div>
      </div>
    </div>
    }

    @if (!loading() && !error()) {
      <div appTableWrapper>
        <table appDataTable class="assets-table">
          <thead>
            <tr>
              @for (column of columnKeys(); track trackByColumn($index, column)) {
                <th>{{ formatHeader(column) }}</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (row of filteredRows(); track trackByRow($index, row)) {
              <tr>
                @for (column of columnKeys(); track trackByColumn($index, column)) {
                  <td>{{ formatCell(row[column]) }}</td>
                }
              </tr>
            }
            @if (filteredRows().length === 0) {
              <tr>
                <td [attr.colspan]="columnKeys().length">
                  <app-state
                    type="empty"
                    icon="pi pi-info-circle"
                    message="No assets found"
                    size="compact"
                  ></app-state>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>
