<div appPageContainer>
  <div appPageHeader>
    <div>
      <h1 class="page-title">Quota Prices</h1>
      <p class="page-subtitle">Upload and manage quota prices data</p>
    </div>
    <div appPageActions>
      <button
        appButton
        class="btn btn-primary"
        type="button"
        (click)="handleUpload()"
        [disabled]="!canUpload()"
      >
        @if (isProcessing()) {
          <i class="pi pi-spinner pi-spin"></i>
        }
        <span>{{ isProcessing() ? 'Uploading...' : 'Upload' }}</span>
      </button>
    </div>
  </div>

  <div class="cards-grid">
    <div class="card">
      <div class="card-header">
        <h3>Upload Quota Prices</h3>
      </div>
      <div class="card-body">
        <div
          class="upload-drop"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
        >
          <input
            type="file"
            id="quotaFileInput"
            class="upload-input"
            accept=".xlsx,.xls"
            (change)="onFileInputChange($event)"
            [disabled]="isProcessing()"
          />
          <label for="quotaFileInput" class="upload-label">
            <span class="upload-title">Drop the Excel file here or click to browse</span>
            <span class="upload-subtitle">Accepted formats: .xlsx, .xls</span>
          </label>
        </div>

        @if (uploadStatus()) {
          <div class="status-message" [class.error]="uploadStatus()?.type === 'error'">
            {{ uploadStatus()?.message }}
          </div>
        }

        @if (uploadedFiles().length > 0) {
          <div class="file-list">
            <div class="file-row">
              <div class="file-info">
                <span class="file-name" [class.invalid]="!uploadedFiles()[0].isValid">
                  {{ uploadedFiles()[0].name }}
                </span>
                <span class="file-size">{{ uploadedFiles()[0].size | number }} bytes</span>
                @if (!uploadedFiles()[0].isValid) {
                  <span class="file-error">
                    {{ uploadedFiles()[0].error }}
                  </span>
                }
              </div>
              <button
                type="button"
                appButton
                class="btn btn-icon btn-text remove-btn"
                (click)="removeFile()"
                [disabled]="isProcessing()"
              >
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>
        }
      </div>
    </div>

    <div class="card">
      <div class="card-header table-header">
        <div>
          <h3>Quota Prices Data</h3>
          <p class="card-subtitle">Values formatted with 8 decimal places</p>
        </div>
        <div class="table-actions">
          <button appButton class="btn btn-ghost" type="button" (click)="copyTable()">
            <i class="fa-regular fa-copy"></i>
            Copy Table
          </button>
          <button appButton class="btn btn-ghost" type="button" (click)="exportCsv('USA')">
            <i class="fa-solid fa-download"></i>
            Export CSV USA
          </button>
          <button appButton class="btn btn-ghost" type="button" (click)="exportCsv('BR')">
            <i class="fa-solid fa-download"></i>
            Export CSV BR
          </button>
        </div>
      </div>
      <div class="card-body">
        @if (isLoading()) {
          <app-state
            type="loading"
            icon="pi pi-spinner pi-spin"
            message="Loading quota prices..."
          ></app-state>
        }

        @if (error() && !isLoading()) {
          <app-state
            type="error"
            icon="pi pi-exclamation-circle"
            [message]="error() || ''"
            actionLabel="Retry"
            (action)="loadQuotaPrices()"
          ></app-state>
        }

        @if (!isLoading() && !error()) {
          <div appTableWrapper>
            <table appDataTable class="quota-table">
              <thead>
                <tr>
                  @for (col of columns(); track trackByColumn($index, col)) {
                    <th [class.text-right]="col !== 'date_reference'">
                      {{ col === 'date_reference' ? 'Date Reference' : col }}
                    </th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (row of rows(); track trackByRow($index, row)) {
                  <tr>
                    @for (col of columns(); track trackByColumn($index, col)) {
                      <td
                        [class.text-right]="col !== 'date_reference'"
                        [class.missing]="getCellStyle(row, col).isMissing"
                        [class.first]="getCellStyle(row, col).isFirstNonNull"
                      >
                        {{
                          col === 'date_reference'
                            ? formatDateReference(row['date_reference'])
                            : formatNumber(row[col])
                        }}
                      </td>
                    }
                  </tr>
                }
                @if (rows().length === 0) {
                  <tr>
                    <td [attr.colspan]="columns().length">
                      <app-state
                        type="empty"
                        icon="pi pi-info-circle"
                        message="No quota prices found"
                        size="compact"
                      ></app-state>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
  </div>
</div>
