<div appPageContainer>
  <div appPageHeader>
    <div>
      <a class="back-link" [routerLink]="['/research-equities/companies']">
        <i class="pi pi-arrow-left"></i>
        Back to Companies
      </a>
      <h1 class="page-title">{{ companyName() }}</h1>
      <p class="page-subtitle">Company details and research materials</p>
    </div>
  </div>

  @if (companyLoading()) {
    <div class="loading-state">
      <i class="pi pi-spinner pi-spin"></i>
      <p>Loading company...</p>
    </div>
  }

  @if (companyError() && !companyLoading()) {
    <div class="error-state">
      <i class="pi pi-exclamation-circle"></i>
      <p>{{ companyError() }}</p>
      <button type="button" class="btn btn-secondary" (click)="retryCompany()">
        <i class="pi pi-refresh"></i>
        <span>Retry</span>
      </button>
    </div>
  }

  @if (!companyLoading() && !companyError()) {
    <div class="detail-content">
    <div class="tabs">
      <button
        class="tab-btn"
        type="button"
        [class.active]="activeTab() === 'financials'"
        (click)="setTab('financials')"
      >
        <i class="pi pi-chart-bar"></i>
        Financials
      </button>
      <button
        class="tab-btn"
        type="button"
        [class.active]="activeTab() === 'documents'"
        (click)="setTab('documents')"
      >
        <i class="pi pi-folder-open"></i>
        Documents
      </button>
      <button
        class="tab-btn"
        type="button"
        [class.active]="activeTab() === 'colmeia'"
        (click)="setTab('colmeia')"
      >
        <i class="pi pi-chart-pie"></i>
        Colmeia
      </button>
    </div>

    @if (activeTab() === 'financials') {
      <div class="tab-panel">
        @if (showFinancialsExpanded()) {
          <div class="expanded-backdrop" (click)="toggleFinancialsExpanded()"></div>
        }
        <div class="financials-stack">
        <div class="financials-top">
          <div class="card colmeia-card">
            <div class="card-header card-header-row">
              <div>
                <h3>Colmeia Evaluation</h3>
                <span class="card-subtitle">
                  {{
                    (colmeiaLatest()?.updated_at || colmeiaLatest()?.created_at)
                      ? ('Updated ' + formatCreatedAt(colmeiaLatest()?.updated_at || colmeiaLatest()?.created_at))
                      : 'No updates available'
                  }}
                </span>
              </div>
              <button class="btn btn-outline" type="button" disabled>
                <i class="pi pi-pencil"></i>
                <span>Edit Colmeia</span>
              </button>
            </div>

            <div class="colmeia-grid">
              <div class="colmeia-left">
                <div class="score-box">
                  <div class="score-label">Official Score</div>
                  <div class="score-value" [ngStyle]="getScoreStyle(colmeiaLatest()?.score_final_geral || 0)">
                    {{ (colmeiaLatest()?.score_final_geral || 0) | number: '1.1-1' }}
                    <span>/5</span>
                  </div>
                  <div class="score-subtitle">of 5.0</div>
                </div>
                @if (colmeiaCategories().length > 0) {
                  <div class="colmeia-chart">
                    <p-chart
                      type="radar"
                      [data]="colmeiaRadarData()"
                      [options]="radarChartOptions"
                    ></p-chart>
                  </div>
                }
              </div>

              <div class="colmeia-right">
                <div class="list-title">Evaluated Categories</div>
                <div class="colmeia-categories">
                  @for (category of colmeiaCategories(); track category.label) {
                    <div class="category-row">
                      <span>{{ category.label }}</span>
                      <span class="score-chip" [ngStyle]="getScoreStyle(category.score)">
                        {{ category.score | number: '1.1-1' }}
                      </span>
                    </div>
                  }
                  @if (colmeiaCategories().length === 0) {
                    <div class="empty-state compact">
                      <p>No categories available.</p>
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>

          <div class="charts-grid">
            <div class="card chart-card">
              <div class="card-header">
                <h3>Margins</h3>
              </div>
              @if ((marginsChartData().labels?.length || 0) > 0) {
                <div class="chart-body">
                  <p-chart
                    type="line"
                    [data]="marginsChartData()"
                    [options]="lineChartOptions"
                  ></p-chart>
                </div>
              } @else {
                <p class="empty-state compact">No margins data available.</p>
              }
            </div>

            <div class="card chart-card">
              <div class="card-header">
                <h3>Growth</h3>
              </div>
              @if ((growthChartData().labels?.length || 0) > 0) {
                <div class="chart-body">
                  <p-chart
                    type="line"
                    [data]="growthChartData()"
                    [options]="lineChartOptions"
                  ></p-chart>
                </div>
              } @else {
                <p class="empty-state compact">No growth data available.</p>
              }
            </div>
          </div>
        </div>

        <div class="card financials-table" [class.expanded-mode]="showFinancialsExpanded()">
          <div class="card-header">
            <h3>Financial Data</h3>
          </div>

          <div class="financials-toolbar">
            <button class="btn toolbar-btn" type="button" (click)="toggleFinancialsExpanded()">
              <i class="pi pi-expand"></i>
              <span>{{ showFinancialsExpanded() ? 'Collapse Table' : 'Expand Table' }}</span>
            </button>
            <button
              class="btn toolbar-btn"
              type="button"
              (click)="copySelectedFinancialRows()"
              [disabled]="selectedFinancialRows().size === 0"
            >
              <i class="pi pi-copy"></i>
              <span>Copy Selected Rows</span>
            </button>
            <button class="btn toolbar-btn" type="button" (click)="copyFinancialTable()">
              <i class="pi pi-table"></i>
              <span>Copy Table</span>
            </button>
          </div>

          @if (financialsLoading()) {
            <div class="loading-state small">
              <i class="pi pi-spinner pi-spin"></i>
              <p>Loading financials...</p>
            </div>
          }

          @if (financialsError() && !financialsLoading()) {
            <div class="error-state small">
              <i class="pi pi-exclamation-circle"></i>
              <p>{{ financialsError() }}</p>
            </div>
          }

          @if (!financialsLoading() && !financialsError()) {
            @if (financialSections().length === 0) {
              <div class="empty-state compact">
                <p>No financial data available.</p>
              </div>
            }

            @for (section of financialSections(); track section.sectionLabel) {
              <div class="financial-section">
                <div class="section-header">
                  <h4>{{ section.sectionLabel }}</h4>
                </div>
                @if (section.sectionData.length > 0) {
                  <div
                    class="financials-table-wrapper"
                    appTableWrapper
                    [class.expanded]="showFinancialsExpanded()"
                  >
                    <table appDataTable class="financials-data-table">
                      <thead>
                        <tr>
                          <th class="checkbox-col"></th>
                          <th>Series</th>
                          <th>Unit</th>
                          @for (date of financialDateColumns(); track date) {
                            <th>{{ date }}</th>
                          }
                        </tr>
                      </thead>
                      <tbody>
                        @for (row of section.sectionData; track row.series_code) {
                          <tr [class.selected]="isFinancialRowSelected(row.series_code)">
                            <td class="checkbox-col">
                              <app-checkbox
                                [checked]="isFinancialRowSelected(row.series_code)"
                                (checkedChange)="toggleFinancialRowSelection(row.series_code)"
                                inputClass="row-checkbox"
                              ></app-checkbox>
                            </td>
                            <td>{{ row.description || row.series_code }}</td>
                            <td>{{ row.unit || '-' }}</td>
                            @for (date of financialDateColumns(); track date) {
                              <td>
                                {{ formatFinancialValue(getSeriesValue(row, date)) }}
                              </td>
                            }
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                }
                @if (section.sectionData.length === 0) {
                  <div class="empty-state compact">
                    <p>No data for {{ section.sectionLabel }}.</p>
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    </div>

    @if (activeTab() === 'documents') {
      <div class="tab-panel">
        @if (documentsLoading()) {
          <div class="loading-state small">
            <i class="pi pi-spinner pi-spin"></i>
            <p>Loading documents...</p>
          </div>
        }

        @if (documentsError() && !documentsLoading()) {
          <div class="error-state small">
            <i class="pi pi-exclamation-circle"></i>
            <p>{{ documentsError() }}</p>
            <button type="button" class="btn btn-secondary btn-compact" (click)="retryDocuments()">
              <i class="pi pi-refresh"></i>
              <span>Retry</span>
            </button>
          </div>
        }

        @if (!documentsLoading() && !documentsError()) {
          <div class="documents-stack">
        <div class="documents-toolbar">
          <div class="documents-actions">
            <button
              class="btn btn-ghost"
              type="button"
              [disabled]="!latestThesis()"
              (click)="downloadLatest('thesis')"
            >
              <i class="pi pi-file"></i>
              <span>Thesis</span>
            </button>
            <button
              class="btn btn-ghost"
              type="button"
              [disabled]="!latestExcel()"
              (click)="downloadLatest('excel')"
            >
              <i class="pi pi-download"></i>
              <span>Models</span>
            </button>
            <button
              class="btn btn-ghost"
              type="button"
              [disabled]="!latestDocument()"
              (click)="downloadLatest('document')"
            >
              <i class="pi pi-file-pdf"></i>
              <span>Cases</span>
            </button>
          </div>

          <div class="documents-actions">
            <button class="btn btn-secondary" type="button" disabled>
              <i class="pi pi-plus"></i>
              <span>Financial Models</span>
            </button>
            <button class="btn btn-secondary" type="button" disabled>
              <i class="pi pi-plus"></i>
              <span>Cases & Other</span>
            </button>
            <button class="btn btn-secondary" type="button" disabled>
              <i class="pi pi-plus"></i>
              <span>Investment Thesis</span>
            </button>
          </div>
        </div>
        <span class="hint-text">Upload flows are not wired in Angular yet.</span>

            <div class="document-section">
              <div class="section-header">
                <h3>Documents ({{ orderedDocuments().length }})</h3>
              </div>
              <div class="section-body">
                @if (orderedDocuments().length === 0) {
                  <div class="empty-state compact">
                    <p>No documents available.</p>
                  </div>
                }
                @if (orderedDocuments().length > 0) {
                  <div appTableWrapper class="table-wrapper">
                    <table appDataTable class="data-table">
                      <thead>
                        <tr>
                          <th>Reference Date</th>
                          <th>Type</th>
                          <th>Created At</th>
                          <th>Created By</th>
                          <th class="actions-col">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (doc of orderedDocuments(); track doc.filePath) {
                          <tr>
                            <td>{{ getReferenceDateLabel(doc) }}</td>
                            <td>{{ doc.type }}</td>
                            <td>{{ formatCreatedAt(doc.created_at) }}</td>
                            <td>
                              {{ doc.user_name || 'Unknown' }}
                              @if (doc.user_email) {
                                <span>• {{ doc.user_email }}</span>
                              }
                            </td>
                            <td class="actions-col">
                              <button
                                class="btn btn-text"
                                type="button"
                                (click)="downloadDocument(doc.filePath)"
                              >
                                <i class="pi pi-download"></i>
                                <span>Download</span>
                              </button>
                              <button
                                class="btn btn-text btn-danger"
                                appButton
                                type="button"
                                (click)="requestDeleteCompanyDocument(doc)"
                              >
                                <i class="pi pi-trash"></i>
                                <span>Delete</span>
                              </button>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    }

    @if (activeTab() === 'colmeia') {
      <div class="tab-panel">
        <div class="card colmeia-history">
          <div class="card-header card-header-row">
            <div>
              <h3>Colmeia History</h3>
            </div>
          </div>

          @if (colmeiaLoading()) {
            <div class="loading-state small">
              <i class="pi pi-spinner pi-spin"></i>
              <p>Loading history...</p>
            </div>
          }

          @if (colmeiaError() && !colmeiaLoading()) {
            <div class="error-state small">
              <i class="pi pi-exclamation-circle"></i>
              <p>{{ colmeiaError() }}</p>
            </div>
          }

          @if (!colmeiaLoading() && !colmeiaError()) {
            @if (colmeiaHistoryRows().length === 0) {
              <div class="empty-state compact">
                <p>No colmeia history available.</p>
              </div>
            }
            @if (colmeiaHistoryRows().length > 0) {
              <div appTableWrapper class="table-wrapper">
                <table appDataTable class="colmeia-history-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Date</th>
                      <th>Final Score</th>
                      <th>Governance</th>
                      <th>People Management</th>
                      <th>Processes and Operations</th>
                      <th>Innovation</th>
                      <th>Environmental Sustainability</th>
                      <th>Social Responsibility</th>
                      <th>Financial Transparency</th>
                      <th>Owner</th>
                      <th class="actions-col">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (row of colmeiaHistoryRows(); track row.version) {
                      <tr>
                        <td>{{ row.version }}</td>
                        <td>{{ row.date }}</td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.finalScore.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.finalScore.variation)"
                            >
                              ({{ formatVariation(row.finalScore.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.governance.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.governance.variation)"
                            >
                              ({{ formatVariation(row.governance.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.peopleManagement.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.peopleManagement.variation)"
                            >
                              ({{ formatVariation(row.peopleManagement.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.processesAndOperations.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.processesAndOperations.variation)"
                            >
                              ({{ formatVariation(row.processesAndOperations.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.innovation.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.innovation.variation)"
                            >
                              ({{ formatVariation(row.innovation.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.environmentalSustainability.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.environmentalSustainability.variation)"
                            >
                              ({{ formatVariation(row.environmentalSustainability.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.socialResponsibility.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.socialResponsibility.variation)"
                            >
                              ({{ formatVariation(row.socialResponsibility.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="score-cell">
                            <div class="score-main">
                              {{ row.financialTransparency.score | number: '1.1-1' }}
                            </div>
                            <div
                              class="score-variation"
                              [class]="getVariationClass(row.financialTransparency.variation)"
                            >
                              ({{ formatVariation(row.financialTransparency.variation) }})
                            </div>
                          </div>
                        </td>
                        <td>{{ row.owner }}</td>
                        <td class="actions-col">
                          <button class="btn btn-icon btn-text" type="button" disabled>
                            <i class="pi pi-eye"></i>
                          </button>
                          <button class="btn btn-icon btn-text btn-danger" type="button" disabled>
                            <i class="pi pi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          }
        </div>
      </div>
    }
  </div>
}
</div>

@if (confirmDocument()) {
  <app-confirm-dialog
    title="Delete document"
    [message]="
      'Delete \"' +
      (confirmDocument()?.filePath ? getFileName(confirmDocument()?.filePath) : 'document') +
      '\"?'
    "
    confirmLabel="Delete"
    confirmVariant="danger"
    (confirm)="confirmDeleteCompanyDocument()"
    (cancel)="cancelDeleteCompanyDocument()"
  ></app-confirm-dialog>
}
