<div appPageContainer>
  <div appPageHeader>
    <div>
      <h1 class="page-title">WPA NAV</h1>
      <p class="page-subtitle">Initial implementation only with ACCOUNTING information.</p>
    </div>
  </div>

  <div class="tabs">
    @for (tab of tabs; track tab.key) {
      <button
        class="tab-btn"
        type="button"
        [class.active]="activeTab() === tab.key"
        (click)="setTab(tab.key)"
      >
        <i [class]="tab.icon"></i>
        <span>{{ tab.label }}</span>
      </button>
    }
  </div>

  @if (activeTab() === 'tables_illiquid') {
    <div class="nav-toolbar">
      <div class="date-field">
        <label>Reference date</label>
        <input
          class="date-input"
          type="date"
          [value]="illiquidDate()"
          (change)="onIlliquidDateChange($any($event.target).value)"
        />
      </div>
    </div>

    @if (illiquidLoading()) {
      <app-state
        type="loading"
        icon="pi pi-spinner pi-spin"
        message="Loading illiquid tables..."
      ></app-state>
    } @else if (illiquidError()) {
      <app-state
        type="error"
        icon="pi pi-exclamation-circle"
        [message]="illiquidError() || ''"
      ></app-state>
    } @else {
      <div class="table-stack">
        <div class="table-card">
          <div class="table-card-header">
            <h3>Total dos grupos na data: {{ illiquidDate() | date: 'dd-MMM-yyyy' }}</h3>
          </div>
          @if (illiquidGrouped().length === 0) {
            <app-state
              type="empty"
              icon="pi pi-info-circle"
              message="No grouped data found."
              size="compact"
            ></app-state>
          } @else {
            <div appTableContainer>
              <div appTableWrapper>
                <table appDataTable>
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th>WPA Value Sum</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of illiquidGrouped(); track item.asset_type_name) {
                      <tr>
                        <td>{{ item.asset_type_name || '-' }}</td>
                        <td>{{ formatNumber(item.wpa_value_sum) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }
        </div>

        <div class="table-card">
          <div class="table-card-header">
            <h3>Saldo de cada ativo na data: {{ illiquidDate() | date: 'dd-MMM-yyyy' }}</h3>
          </div>
          @if (illiquidDistinct().length === 0) {
            <app-state
              type="empty"
              icon="pi pi-info-circle"
              message="No asset balances found."
              size="compact"
            ></app-state>
          } @else {
            <div appTableContainer>
              <div appTableWrapper>
                <table appDataTable>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>WPA Value (BRL)</th>
                      <th>Comment</th>
                      <th>Date Reference</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of illiquidDistinct(); track item.asset_name) {
                      <tr>
                        <td>{{ item.asset_name || '-' }}</td>
                        <td>{{ item.asset_type_name || '-' }}</td>
                        <td>
                          <span
                            class="value"
                            [class.value-negative]="(item.wpa_value_in_brl ?? 0) < 0"
                            [class.value-positive]="(item.wpa_value_in_brl ?? 0) >= 0"
                          >
                            R$ {{ (item.wpa_value_in_brl ?? 0) < 0 ? '-' : '' }}{{ formatBrlValue(item.wpa_value_in_brl) }}
                          </span>
                        </td>
                        <td>{{ item.comment || '-' }}</td>
                        <td>{{ item.date_reference ? (item.date_reference | date: 'yyyy-MM-dd') : '-' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          }
        </div>
      </div>
    }
  } @else if (activeTab() === 'chart_liquid') {
    <div class="nav-toolbar">
      <div class="date-field">
        <label>Reference date</label>
        @if (availableDatesLoading()) {
          <div class="loading-inline">Loading dates...</div>
        } @else if (availableDatesError()) {
          <div class="error-inline">{{ availableDatesError() }}</div>
        } @else {
          <select
            class="select-input"
            [value]="liquidDate()"
            (change)="onLiquidDateChange($any($event.target).value)"
          >
            @for (date of availableDates(); track date) {
              <option [value]="date">{{ date | date: 'dd-MMM-yyyy' }}</option>
            }
          </select>
        }
      </div>
    </div>

    @if (weightsLoading()) {
      <app-state type="loading" icon="pi pi-spinner pi-spin" message="Loading charts..."></app-state>
    } @else if (weightsError()) {
      <app-state
        type="error"
        icon="pi pi-exclamation-circle"
        [message]="weightsError() || ''"
      ></app-state>
    } @else if (liquidChartData().length === 0) {
      <app-state
        type="empty"
        icon="pi pi-info-circle"
        message="No weight data available."
      ></app-state>
    } @else {
      <div class="chart-card">
        @if (liquidChartOptions()) {
          <ag-charts class="chart-container" [options]="liquidChartOptions()!"></ag-charts>
        }
      </div>
    }
  } @else if (activeTab() === 'tables_liquid') {
    <div class="nav-toolbar">
      <div class="date-field">
        <label>Reference date</label>
        @if (availableDatesLoading()) {
          <div class="loading-inline">Loading dates...</div>
        } @else if (availableDatesError()) {
          <div class="error-inline">{{ availableDatesError() }}</div>
        } @else {
          <select
            class="select-input"
            [value]="liquidDate()"
            (change)="onLiquidDateChange($any($event.target).value)"
          >
            @for (date of availableDates(); track date) {
              <option [value]="date">{{ date | date: 'dd-MMM-yyyy' }}</option>
            }
          </select>
        }
      </div>
    </div>

    @if (liquidLoading()) {
      <app-state type="loading" icon="pi pi-spinner pi-spin" message="Loading liquid assets..."></app-state>
    } @else if (liquidError()) {
      <app-state
        type="error"
        icon="pi pi-exclamation-circle"
        [message]="liquidError() || ''"
      ></app-state>
    } @else if (liquidValues().length === 0) {
      <app-state
        type="empty"
        icon="pi pi-info-circle"
        message="No liquid assets available."
      ></app-state>
    } @else {
      <div class="table-card liquid-table">
        <div class="table-card-header">
          <div>
            <h3>
              Liquid Assets - {{ liquidDate() ? (liquidDate() | date: 'dd-MMM-yyyy') : '-' }}
            </h3>
            <p class="table-card-subtitle">Consolidated portfolio exposure and ownership.</p>
          </div>
          <div class="table-card-meta">{{ liquidValues().length }} rows</div>
        </div>
        <div appTableContainer>
          <div appTableWrapper>
            <table appDataTable>
              <thead>
                <tr>
                  <th>Portfolio Name</th>
                  <th class="mono">Portfolio ID</th>
                  <th>Date Reference</th>
                  <th class="numeric">Total Original Position</th>
                  <th>Portfolio Original Currency</th>
                  <th class="numeric">FX Rate</th>
                  <th>FX Date Reference</th>
                  <th>Portfolio New Currency</th>
                  <th class="numeric">Portfolio Value in BRL</th>
                  <th class="numeric">Percentage Ownership</th>
                  <th>WPA Stake Date Reference</th>
                  <th>WPA Stake Comment</th>
                  <th class="numeric">Net WPA Stake</th>
                </tr>
              </thead>
              <tbody>
                @for (row of liquidValues(); track row.portfolio_id) {
                  <tr>
                    <td>{{ row.portfolio_name || '-' }}</td>
                    <td class="mono">{{ row.portfolio_id || '-' }}</td>
                    <td>{{ row.date_reference ? (row.date_reference | date: 'yyyy-MM-dd') : '-' }}</td>
                    <td class="numeric">
                      {{
                        row.total_original_position
                          ? row.total_original_position.toLocaleString('pt-BR', { style: 'decimal' })
                          : '$ 0.00'
                      }}
                    </td>
                    <td>{{ row.portfolio_original_currency || '-' }}</td>
                    <td class="numeric">{{ formatFxRate(row.fx_rate) }}</td>
                    <td>{{ row.fx_date_reference ? (row.fx_date_reference | date: 'yyyy-MM-dd') : '-' }}</td>
                    <td>{{ row.portfolio_new_currency || '-' }}</td>
                    <td class="numeric">{{ formatCurrencyBRL(row.portfolio_value_in_brl) }}</td>
                    <td class="numeric">{{ formatPercentage(row.percentage_ownership) }}</td>
                    <td>
                      {{
                        row.wpa_stake_date_reference
                          ? (row.wpa_stake_date_reference | date: 'yyyy-MM-dd')
                          : '-'
                      }}
                    </td>
                    <td>{{ row.wpa_stake_comment || '-' }}</td>
                    <td class="numeric">
                      {{
                        row.net_wpa_stake
                          ? row.net_wpa_stake.toLocaleString('en-US', { style: 'decimal' })
                          : '0,00'
                      }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    }
  }
</div>
